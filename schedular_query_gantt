SELECT
    s_site_id                                        AS site_id,
    pj_project_id                                    AS project_id,
    pj_project_name                                  AS project_name,
    m_market                                         AS market,
    pj_p_4225_construction_start_finish              AS construction_start_4225,

    -- ══════════════════════════════════════════════
    -- MILESTONE 3710: Entitlement Complete
    -- Starts from: Site Assigned to Nokia
    -- Expected days: 0 (immediate)
    -- ══════════════════════════════════════════════

    pj_p_3710_ran_entitlement_complete_finish        AS planned_finish_3710,
    pj_a_3710_ran_entitlement_complete_finish        AS actual_finish_3710,
    '0'                                              AS expected_days_3710,

    CASE
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN CURRENT_DATE - pj_a_3710_ran_entitlement_complete_finish::date
        ELSE NULL
    END                                              AS days_since_completion_3710,

    CASE
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NULL
          AND pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN pj_p_3710_ran_entitlement_complete_finish::date - CURRENT_DATE
        ELSE NULL
    END                                              AS days_remaining_3710,

    CASE
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NOT NULL
          AND pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
          AND pj_a_3710_ran_entitlement_complete_finish::date
              < pj_p_3710_ran_entitlement_complete_finish::date
        THEN 'COMPLETED EARLY'
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NOT NULL
          AND pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
          AND pj_a_3710_ran_entitlement_complete_finish::date
              = pj_p_3710_ran_entitlement_complete_finish::date
        THEN 'COMPLETED ON TIME'
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NOT NULL
          AND pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
          AND pj_a_3710_ran_entitlement_complete_finish::date
              > pj_p_3710_ran_entitlement_complete_finish::date
        THEN 'COMPLETED LATE'
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NULL
          AND pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
          AND pj_p_3710_ran_entitlement_complete_finish::date >= CURRENT_DATE
        THEN 'IN PROGRESS (ON TRACK)'
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NULL
          AND pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
          AND pj_p_3710_ran_entitlement_complete_finish::date < CURRENT_DATE
        THEN 'DELAYED'
        ELSE 'NOT STARTED'
    END                                              AS status_3710,

    -- ══════════════════════════════════════════════
    -- PATH 1 (TOP): BOM CHAIN
    -- ══════════════════════════════════════════════

    -- ── MILESTONE 3850: BOM in BAT Tool ──
    -- Chains from: 3710 + 2 days
    -- Expected days: 2
    -- Client condition: Non blanks & ≥4 weeks before 4225 P Date

    CASE
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN pj_a_3710_ran_entitlement_complete_finish::date + 1
        WHEN pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN pj_p_3710_ran_entitlement_complete_finish::date + 1
        ELSE NULL
    END                                              AS start_date_3850,

    '2'                                              AS expected_days_3850,

    CASE
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN pj_a_3710_ran_entitlement_complete_finish::date + 1 + 2
        WHEN pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN pj_p_3710_ran_entitlement_complete_finish::date + 1 + 2
        ELSE NULL
    END                                              AS planned_finish_3850,

    pj_a_3850_bom_submitted_bom_in_bat_finish        AS actual_finish_3850,

    CASE
        WHEN pj_a_3850_bom_submitted_bom_in_bat_finish IS NOT NULL
        THEN CURRENT_DATE - pj_a_3850_bom_submitted_bom_in_bat_finish::date
        ELSE NULL
    END                                              AS days_since_completion_3850,

    CASE
        WHEN pj_a_3850_bom_submitted_bom_in_bat_finish IS NOT NULL
          AND pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
          AND pj_a_3850_bom_submitted_bom_in_bat_finish::date
              <= (pj_p_3710_ran_entitlement_complete_finish::date + 3)
        THEN 'COMPLETED ON TIME'
        WHEN pj_a_3850_bom_submitted_bom_in_bat_finish IS NOT NULL
        THEN 'COMPLETED LATE'
        WHEN pj_a_3850_bom_submitted_bom_in_bat_finish IS NULL
          AND pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
          AND (pj_p_3710_ran_entitlement_complete_finish::date + 3) >= CURRENT_DATE
        THEN 'IN PROGRESS (ON TRACK)'
        WHEN pj_a_3850_bom_submitted_bom_in_bat_finish IS NULL
          AND pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
          AND (pj_p_3710_ran_entitlement_complete_finish::date + 3) < CURRENT_DATE
        THEN 'DELAYED'
        ELSE 'NOT STARTED'
    END                                              AS status_3850,

    -- ★ Client 4225 check for 3850
    CASE
        WHEN pj_a_3850_bom_submitted_bom_in_bat_finish IS NULL
        THEN 'NOT READY — BOM date blank'
        WHEN pj_p_4225_construction_start_finish IS NULL
        THEN 'NO 4225 DATE'
        WHEN (pj_p_4225_construction_start_finish::date
              - pj_a_3850_bom_submitted_bom_in_bat_finish::date) >= 28
        THEN 'PASS — ≥4 weeks before Cx start'
        ELSE 'FAIL — <4 weeks before Cx start'
    END                                              AS client_4225_check_3850,

    -- ── MILESTONE 3875: BOM in AIMS ──
    -- Chains from: 3850 + 21 days
    -- Expected days: 21
    -- Client condition: Non blanks & ≥1 week before 4225 P Date

    CASE
        WHEN pj_a_3850_bom_submitted_bom_in_bat_finish IS NOT NULL
        THEN pj_a_3850_bom_submitted_bom_in_bat_finish::date + 1
        ELSE NULL
    END                                              AS start_date_3875,

    '21'                                             AS expected_days_3875,

    CASE
        WHEN pj_a_3850_bom_submitted_bom_in_bat_finish IS NOT NULL
        THEN pj_a_3850_bom_submitted_bom_in_bat_finish::date + 1 + 21
        ELSE NULL
    END                                              AS planned_finish_3875,

    pj_a_3875_bom_received_bom_in_aims_finish        AS actual_finish_3875,

    CASE
        WHEN pj_a_3875_bom_received_bom_in_aims_finish IS NOT NULL
        THEN CURRENT_DATE - pj_a_3875_bom_received_bom_in_aims_finish::date
        ELSE NULL
    END                                              AS days_since_completion_3875,

    CASE
        WHEN pj_a_3875_bom_received_bom_in_aims_finish IS NOT NULL
          AND pj_a_3850_bom_submitted_bom_in_bat_finish IS NOT NULL
          AND pj_a_3875_bom_received_bom_in_aims_finish::date
              <= (pj_a_3850_bom_submitted_bom_in_bat_finish::date + 22)
        THEN 'COMPLETED ON TIME'
        WHEN pj_a_3875_bom_received_bom_in_aims_finish IS NOT NULL
        THEN 'COMPLETED LATE'
        WHEN pj_a_3875_bom_received_bom_in_aims_finish IS NULL
          AND pj_a_3850_bom_submitted_bom_in_bat_finish IS NOT NULL
          AND (pj_a_3850_bom_submitted_bom_in_bat_finish::date + 22) >= CURRENT_DATE
        THEN 'IN PROGRESS (ON TRACK)'
        WHEN pj_a_3875_bom_received_bom_in_aims_finish IS NULL
          AND pj_a_3850_bom_submitted_bom_in_bat_finish IS NOT NULL
        THEN 'DELAYED'
        ELSE 'NOT STARTED'
    END                                              AS status_3875,

    -- ★ Client 4225 check for 3875
    CASE
        WHEN pj_a_3875_bom_received_bom_in_aims_finish IS NULL
        THEN 'NOT READY — BOM material date blank'
        WHEN pj_p_4225_construction_start_finish IS NULL
        THEN 'NO 4225 DATE'
        WHEN (pj_p_4225_construction_start_finish::date
              - pj_a_3875_bom_received_bom_in_aims_finish::date) >= 7
        THEN 'PASS — ≥1 week before Cx start'
        ELSE 'FAIL — <1 week before Cx start'
    END                                              AS client_4225_check_3875,

    -- ── MILESTONE 3925: Material Picked Up by GC ──
    -- Chains from: 3875 + 7 days
    -- Expected days: 7
    -- Client condition: Non blanks & ≥1 week before 4225 P Date

    CASE
        WHEN pj_a_3875_bom_received_bom_in_aims_finish IS NOT NULL
        THEN pj_a_3875_bom_received_bom_in_aims_finish::date + 1
        ELSE NULL
    END                                              AS start_date_3925,

    '7'                                              AS expected_days_3925,

    CASE
        WHEN pj_a_3875_bom_received_bom_in_aims_finish IS NOT NULL
        THEN pj_a_3875_bom_received_bom_in_aims_finish::date + 1 + 7
        ELSE NULL
    END                                              AS planned_finish_3925,

    pj_a_3925_msi_pickup_date_finish                 AS actual_finish_3925,

    CASE
        WHEN pj_a_3925_msi_pickup_date_finish IS NOT NULL
        THEN CURRENT_DATE - pj_a_3925_msi_pickup_date_finish::date
        ELSE NULL
    END                                              AS days_since_completion_3925,

    CASE
        WHEN pj_a_3925_msi_pickup_date_finish IS NOT NULL
          AND pj_a_3875_bom_received_bom_in_aims_finish IS NOT NULL
          AND pj_a_3925_msi_pickup_date_finish::date
              <= (pj_a_3875_bom_received_bom_in_aims_finish::date + 8)
        THEN 'COMPLETED ON TIME'
        WHEN pj_a_3925_msi_pickup_date_finish IS NOT NULL
        THEN 'COMPLETED LATE'
        WHEN pj_a_3925_msi_pickup_date_finish IS NULL
          AND pj_a_3875_bom_received_bom_in_aims_finish IS NOT NULL
          AND (pj_a_3875_bom_received_bom_in_aims_finish::date + 8) >= CURRENT_DATE
        THEN 'IN PROGRESS (ON TRACK)'
        WHEN pj_a_3925_msi_pickup_date_finish IS NULL
          AND pj_a_3875_bom_received_bom_in_aims_finish IS NOT NULL
        THEN 'DELAYED'
        ELSE 'NOT STARTED'
    END                                              AS status_3925,

    -- ★ Client 4225 check for 3925
    CASE
        WHEN pj_a_3925_msi_pickup_date_finish IS NULL
        THEN 'NOT READY — Pickup date blank'
        WHEN pj_p_4225_construction_start_finish IS NULL
        THEN 'NO 4225 DATE'
        WHEN (pj_p_4225_construction_start_finish::date
              - pj_a_3925_msi_pickup_date_finish::date) >= 7
        THEN 'PASS — ≥1 week before Cx start'
        ELSE 'FAIL — <1 week before Cx start'
    END                                              AS client_4225_check_3925,

    -- ══════════════════════════════════════════════
    -- PATH 2 (MIDDLE): NTP CHAIN
    -- ══════════════════════════════════════════════

    -- ── MILESTONE 4100: NTP Received ──
    -- Chains from: 3710 + 2 days (Pre-NTP path)
    -- Expected days: 2
    -- Client condition: Non blanks & ≥4 weeks before 4225 P Date

    CASE
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN pj_a_3710_ran_entitlement_complete_finish::date + 1
        WHEN pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN pj_p_3710_ran_entitlement_complete_finish::date + 1
        ELSE NULL
    END                                              AS start_date_4100,

    '2'                                              AS expected_days_4100,

    CASE
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN pj_a_3710_ran_entitlement_complete_finish::date + 1 + 2
        WHEN pj_p_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN pj_p_3710_ran_entitlement_complete_finish::date + 1 + 2
        ELSE NULL
    END                                              AS planned_finish_4100,

    pj_a_4100_construction_ntp_accepted_by_gc_finish AS actual_finish_4100,

    CASE
        WHEN pj_a_4100_construction_ntp_accepted_by_gc_finish IS NOT NULL
        THEN CURRENT_DATE - pj_a_4100_construction_ntp_accepted_by_gc_finish::date
        ELSE NULL
    END                                              AS days_since_completion_4100,

    CASE
        WHEN pj_a_4100_construction_ntp_accepted_by_gc_finish IS NOT NULL
        THEN 'COMPLETED'
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NOT NULL
          AND (pj_a_3710_ran_entitlement_complete_finish::date + 3) >= CURRENT_DATE
        THEN 'IN PROGRESS (ON TRACK)'
        WHEN pj_a_3710_ran_entitlement_complete_finish IS NOT NULL
        THEN 'DELAYED'
        ELSE 'NOT STARTED'
    END                                              AS status_4100,

    -- ★ Client 4225 check for 4100
    CASE
        WHEN pj_a_4100_construction_ntp_accepted_by_gc_finish IS NULL
        THEN 'NOT READY — NTP date blank'
        WHEN pj_p_4225_construction_start_finish IS NULL
        THEN 'NO 4225 DATE'
        WHEN (pj_p_4225_construction_start_finish::date
              - pj_a_4100_construction_ntp_accepted_by_gc_finish::date) >= 28
        THEN 'PASS — ≥4 weeks before Cx start'
        ELSE 'FAIL — <4 weeks before Cx start'
    END                                              AS client_4225_check_4100,

    -- ══════════════════════════════════════════════
    -- PATH 3 (BOTTOM): SCOPING CHAIN
    -- Site Walk → Ready for Scoping → Scoping Validated
    -- → CRs in CQT → Quote → CPO → SPO
    --                → Access Confirmation
    --                → Crane Readiness
    -- ══════════════════════════════════════════════

    -- ── Site Walk (MS 1321) ──
    ms_1321_talon_view_drone_svcs_actual             AS actual_site_walk,

    -- ── Ready for Scoping (3 days after site walk) ──
    ms_1323_ready_for_scoping_actual                 AS actual_ready_for_scoping,
    '3'                                              AS expected_days_ready_for_scoping,

    -- ── Scoping Validated by GC (7 days after ready for scoping) ──
    ms_1327_scoping_and_quoting_package_validated_actual AS actual_scoping_validated,
    '7'                                              AS expected_days_scoping_validated,

    -- ── All CRs in CQT tool (10 days after scoping validated) ──
    -- No direct DB column — derived milestone
    '10'                                             AS expected_days_crs_in_cqt,

    -- ── Quote to Customer (7 days after CRs) ──
    '7'                                              AS expected_days_quote_to_customer,

    -- ── CPO (14 days after quote) ──
    cpo                                              AS cpo_number,
    '14'                                             AS expected_days_cpo,

    CASE
        WHEN NULLIF(TRIM(cpo), '') IS NOT NULL THEN 'AVAILABLE'
        ELSE 'MISSING'
    END                                              AS cpo_status,

    -- ── SPO (2 days after CPO) ──
    total_spo                                        AS spo_value,
    '2'                                              AS expected_days_spo,

    CASE
        WHEN NULLIF(TRIM(total_spo), '') IS NULL
        THEN 'MISSING — SPO blank'
        WHEN pj_p_4225_construction_start_finish IS NULL
        THEN 'NO 4225 DATE'
        WHEN (pj_p_4225_construction_start_finish::date - CURRENT_DATE) >= 42
        THEN 'PASS — ≥6 weeks to Cx start'
        ELSE 'FAIL — <6 weeks to Cx start'
    END                                              AS client_4225_check_spo,

    -- ── Access Confirmation (7 days after CRs + 7 days) ──
    scop_title                                       AS access_scoping_session,
    '7'                                              AS expected_days_access,

    CASE
        WHEN NULLIF(TRIM(scop_title), '') IS NULL
        THEN 'MISSING — No scoping session'
        WHEN pj_p_4225_construction_start_finish IS NULL
        THEN 'NO 4225 DATE'
        WHEN (pj_p_4225_construction_start_finish::date - CURRENT_DATE) >= 14
        THEN 'PASS — ≥2 weeks to Cx start'
        ELSE 'FAIL — <2 weeks to Cx start'
    END                                              AS client_4225_check_access,

    -- ── Crane Readiness (7 days after CRs + 7 days) ──
    scoping_package_crane_required                   AS crane_required,
    '7'                                              AS expected_days_crane,

    CASE
        WHEN NULLIF(TRIM(scoping_package_crane_required), '') IS NULL
        THEN 'MISSING — Crane decision blank'
        WHEN pj_p_4225_construction_start_finish IS NULL
        THEN 'NO 4225 DATE'
        WHEN (pj_p_4225_construction_start_finish::date - CURRENT_DATE) >= 14
        THEN 'PASS — ≥2 weeks to Cx start'
        ELSE 'FAIL — <2 weeks to Cx start'
    END                                              AS client_4225_check_crane,

    -- ══════════════════════════════════════════════
    -- STEEL PATH (from Entitlement, 14 days)
    -- ══════════════════════════════════════════════

    pj_steel_received_date                           AS steel_received_date,
    pj_steel_received_status                         AS steel_received_status,
    '14'                                             AS expected_days_steel,

    -- ══════════════════════════════════════════════
    -- SITE READY FOR CA (MS 1559 / COP)
    -- ══════════════════════════════════════════════

    scop_checklist_accepted_by_customer              AS cop_checklist_accepted,
    ms_1559_cop_approved_by_t_mobile_actual          AS cop_approved_date,

    CASE
        WHEN NULLIF(TRIM(scop_checklist_accepted_by_customer), '') IS NULL
             AND ms_1559_cop_approved_by_t_mobile_actual IS NULL
        THEN 'NOT READY — No COP acceptance'
        WHEN pj_p_4225_construction_start_finish IS NULL
        THEN 'NO 4225 DATE'
        WHEN (pj_p_4225_construction_start_finish::date - CURRENT_DATE) >= 14
        THEN 'PASS — ≥2 weeks to Cx start'
        ELSE 'FAIL — <2 weeks to Cx start'
    END                                              AS client_4225_check_site_ready

FROM pwc_macro_staging_schema.stg_ndpd_mbt_tmobile_macro_combined

WHERE pj_hard_cost_vendor_assignment_po ILIKE '%NOKIA%'
  AND por_plan_type NOT IN ('Equipment Upgrade', 'FOA')
  AND por_regional_dev_initiatives ILIKE '%2026 Build Plan%';
